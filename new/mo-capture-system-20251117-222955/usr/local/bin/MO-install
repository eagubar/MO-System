#!/bin/bash
# MO-install - Instalador desde templates MO-capture

VERSION="1.0"
LOG_FILE="/var/log/MO-capture.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] MO-install: $1" | tee -a "$LOG_FILE"
}

show_help() {
    echo "MO-install - Instalador desde templates MO-capture"
    echo ""
    echo "Uso: MO-install <template.json>"
    echo "     MO-install --verify <template.json>"
    echo "     MO-install --info <template.json>"
    echo ""
    echo "Opciones:"
    echo "  --verify    Verificar template sin instalar"
    echo "  --info      Mostrar información del template"
    echo "  --help      Mostrar esta ayuda"
    echo ""
    echo "Ejemplo:"
    echo "  MO-install /var/lib/MO-capture/templates/MO-template-*.json"
}

verify_template() {
    local template_file="$1"
    
    if [[ ! -f "$template_file" ]]; then
        log "ERROR: Template no encontrado: $template_file"
        return 1
    fi
    
    if command -v jq >/dev/null 2>&1; then
        if jq empty "$template_file" 2>/dev/null; then
            log "Template verificado: $template_file"
            
            # Mostrar información básica
            local command=$(jq -r '.MO_template.command // "unknown"' "$template_file")
            local timestamp=$(jq -r '.MO_template.timestamp // "unknown"' "$template_file")
            local files_created=$(jq -r '.summary.total_files_created // 0' "$template_file")
            
            echo "=== MO-template Info ==="
            echo "Comando: $command"
            echo "Timestamp: $timestamp"
            echo "Archivos creados: $files_created"
            echo "========================"
            
            return 0
        else
            log "ERROR: Template JSON inválido: $template_file"
            return 1
        fi
    else
        # Verificación básica sin jq
        if grep -q "MO_template" "$template_file"; then
            log "Template verificado (básico): $template_file"
            return 0
        else
            log "ERROR: No es un template MO válido: $template_file"
            return 1
        fi
    fi
}

install_from_template() {
    local template_file="$1"
    
    log "Iniciando instalación desde: $template_file"
    
    if ! verify_template "$template_file"; then
        return 1
    fi
    
    echo "MO-install: Instalando desde template..."
    echo "Template: $template_file"
    
    # En esta versión básica, solo mostramos lo que se instalaría
    if command -v jq >/dev/null 2>&1; then
        local files_created=$(jq -r '.operations.files_created[]?.path // empty' "$template_file")
        
        echo "=== Archivos a instalar ==="
        for file in $files_created; do
            if [[ -n "$file" ]]; then
                if [[ -f "$file" ]]; then
                    echo "[EXISTE] $file"
                else
                    echo "[NUEVO]  $file"
                fi
            fi
        done
    else
        echo "=== Información del template ==="
        grep -A5 -B5 "files_created" "$template_file" | head -20
    fi
    
    log "Instalación simulada completada para: $template_file"
    echo "NOTA: Esta es una versión de demostración. La instalación real se implementará en fases futuras."
}

# Manejo de argumentos
case "${1:-}" in
    "--help"|"-h")
        show_help
        ;;
    "--verify")
        if [[ -n "$2" ]]; then
            verify_template "$2"
        else
            echo "Error: Se requiere archivo template para --verify"
            exit 1
        fi
        ;;
    "--info")
        if [[ -n "$2" ]]; then
            verify_template "$2"  # Por ahora usa verify para mostrar info
        else
            echo "Error: Se requiere archivo template para --info"
            exit 1
        fi
        ;;
    "")
        echo "Error: Se requiere archivo template"
        show_help
        exit 1
        ;;
    *)
        install_from_template "$1"
        ;;
esac
